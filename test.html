<!DOCTYPE html>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="//d3js.org/d3-scale-chromatic.v0.3.min.js"></script>
<body>
<script>

	var width = 800,
		height = 800;
		
	var pack = d3.pack()
		.size([width, height])
		.padding(1.5);
		
	var color = d3.scaleSequential(d3.interpolateRdBu);
	
	color.domain([0, 1]);
		
	var tooltip = d3.select("body")
		.append("div")
		.attr("id", "tooltip")
		.style("position", "absolute")
		.style("background-color", "white")
		.style("hideDelay", 0)
		.on("mouseover", function(d) {
				var node = tooltip.node();
				tooltip.style("display", "block")
					.style("left", Math.max(parseFloat(d3.select(this).attr("cx")) - node.getBoundingClientRect().width, 0) + "px")
					.style("top", Math.max(parseFloat(d3.select(this).attr("cy")) - node.getBoundingClientRect().height, 0) + "px");
			})
			.on("mouseout", function(d) {
				tooltip.style("display", "none");
			});
		
	tooltip = d3.select("#tooltip");
	
	var svg = d3.select("body")
		.append("svg")
		.attr("width", width)
		.attr("height", height);
		
	d3.csv("SkipAverage.csv", function(data) {
		data.AverageSkipPercent = +data["AverageSkipPercent"];
		data.SongName = data["SongName"];
		data.TotalSkips = +data["TotalSkips"];
		return data;
	}, function(error, classes) {

		color.domain([0, classes[0].AverageSkipPercent]);
	    var nodes = d3.hierarchy({children: classes})
			.sum(function(d) { return d.AverageSkipPercent });
			
		var data = pack(nodes).leaves();
			
		var bubbles = svg.selectAll("circle")
			.data(data, function(d) { return d.data.SongName; })
			.enter();
		
		var text = svg.selectAll("text")
			.data(data, function(d) { return d.data.SongName; })
			.enter();

		bubbles.append("circle")
			.attr("r", function(d){ return d.r; })
			.style("fill", function(d, i) { return color(d.data.AverageSkipPercent)})
			.attr("cx", function(d){ return d.x; })
			.attr("cy", function(d){ return d.y; })
			.on("mouseover", function(d) {
				var node = tooltip.node();
				tooltip.style("display", "block")
					.html(d.data.SongName + "<br/>" + (d.data.AverageSkipPercent * 100).toFixed(2) + "%")
					.style("left", Math.max(parseFloat(d3.select(this).attr("cx")) - node.getBoundingClientRect().width, 0) + "px")
					.style("top", Math.max(parseFloat(d3.select(this).attr("cy")) - node.getBoundingClientRect().height, 0) + "px");
				d3.select(this).transition(400).style("fill", "Green");
			})
			.on("mouseout", function(d) {
				tooltip.style("display", "none");
				d3.select(this).transition(400).style("fill", function(d, i) { return color(d.data.AverageSkipPercent)})
;
			});

		 text.append("text")
			.attr("x", function(d){ return d.x; })
			.attr("y", function(d){ return d.y; })
			.text(function(d){ if (d.data.AverageSkipPercent > .35) {
					return d.data.SongName; }})
			.attr("text-anchor", "middle")
			.style('fill', 'white')
			.style('font-family', 'Helvetica Neue, Helvetica, Arial, san-serif')
			.style('font-size', '12px')
			.style('user-select', 'none')
			.on("mouseover", function(d) {
				var node = tooltip.node();
				tooltip.style("display", "block")
					.html(d.data.SongName + "<br/>" + (d.data.AverageSkipPercent * 100).toFixed(2) + "%")
					.style("left", Math.max(parseFloat(d3.select(this).attr("cx")) - node.getBoundingClientRect().width, 0) + "px")
					.style("top", Math.max(parseFloat(d3.select(this).attr("cy")) - node.getBoundingClientRect().height, 0) + "px");
			})
			.on("mouseout", function(d) {
				tooltip.style("display", "none");
			});

			
			d3.select("body").append("input")
				.attr("type", "range")
				.attr("min", 1)
				.attr("max", 3)
				.attr("value", 1)
				.attr("class", "countSelect");
				
			var selected = d3.select(".countSelect");
			
			selected.on("change", function(d) { updateData(selected.property("value")); });
				
			function updateData(num) {
				var s = d3.transition().duration(400);
				var t = d3.transition().duration(750);
				var l = d3.transition().duration(1200);
				var newclasses = classes.filter(function(d) { return d.TotalSkips > num - 1 });
				color.domain([0, newclasses[0].AverageSkipPercent]);
				var newnodes = d3.hierarchy({children: newclasses})
					.sum(function(d) { return d.AverageSkipPercent });
			
				var newdata = pack(newnodes).leaves();
				
				bubbles = svg.selectAll("circle")
					.data(newdata, function(d) { return d.data.SongName; });
				
				text = svg.selectAll("text")
					.data(newdata, function(d) { return d.data.SongName; });
				
				bubbles.exit().transition(t).attr("r", 1e-6).remove();
				text.exit().transition(s).attr("opacity", 1e-6).remove();
				
				bubbles.transition(t)
					.attr("r", function(d){ return d.r; })
					.attr("cx", function(d){ return d.x; })
					.attr("cy", function(d){ return d.y; })
					.style("fill", function(d, i) { return color(d.data.AverageSkipPercent); });
					
				text.transition(t)
					.attr("x", function(d){ return d.x; })
					.attr("y", function(d){ return d.y; })
					.text(function(d){ if (d.data.AverageSkipPercent > newclasses[0].AverageSkipPercent * .35) {
							return d.data.SongName; }});
					
				bubbles.enter()
					.append("circle")
					.attr("r", function(d){ return 1e-6; })
					.attr("cx", function(d){ return d.x; })
					.attr("cy", function(d){ return d.y; })
					.style("fill", function(d, i) { return color(d.data.AverageSkipPercent); })
					.on("mouseover", function(d) {
						var node = tooltip.node();
						tooltip.style("display", "block")
							.html(d.data.SongName + "<br/>" + (d.data.AverageSkipPercent * 100).toFixed(2) + "%")
							.style("left", Math.max(parseFloat(d3.select(this).attr("cx")) - node.getBoundingClientRect().width, 0) + "px")
							.style("top", Math.max(parseFloat(d3.select(this).attr("cy")) - node.getBoundingClientRect().height, 0) + "px");
					})
					.on("mouseout", function(d) {
						tooltip.style("display", "none");
					})
					.transition(t)
					.attr("r", function(d) { return d.r });
					
				text.enter().append("text")
					.attr("opacity", 1e-6)
					.attr("x", function(d){ return d.x; })
					.attr("y", function(d){ return d.y; })
					.text(function(d){ if (d.data.AverageSkipPercent > newclasses[0].AverageSkipPercent * .35) {
							return d.data.SongName; }})
					.attr("text-anchor", "middle")
					.style('fill', 'white')
					.style('font-family', 'Helvetica Neue, Helvetica, Arial, san-serif')
					.style('font-size', '12px')
					.on("mouseover", function(d) {
						var node = tooltip.node();
						tooltip.style("display", "block")
							.html(d.data.SongName + "<br/>" + (d.data.AverageSkipPercent * 100).toFixed(2) + "%")
							.style("left", Math.max(parseFloat(d3.select(this).attr("cx")) - node.getBoundingClientRect().width, 0) + "px")
							.style("top", Math.max(parseFloat(d3.select(this).attr("cy")) - node.getBoundingClientRect().height, 0) + "px");
					})
					.on("mouseout", function(d) {
						tooltip.style("display", "none");
					})
					.transition(l)
					.attr("opacity", 1);
	}});
</script>
</body