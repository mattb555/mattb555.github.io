<!DOCTYPE html>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="//d3js.org/d3-scale-chromatic.v0.3.min.js"></script>
<body>
<script>
	d3.select("body")
		.append("div")
		.attr("class", "headerdiv")
		.style("display", "block")
		.style("max-width", "800px")
		.append("h1")
		.text("Spotify Song Analysis")
		.style("color", "white")
		.style("text-align", "center");
		
	var width = 800,
		height = 800;
		
	var pack = d3.pack()
		.size([width, height])
		.padding(1.5);
			
	var tooltip = d3.select("body")
		.style("background-color", "black")
		.append("div")
		.attr("id", "tooltip")
		.style("position", "absolute")
		.style("background-color", "white")
		.style("hideDelay", 0)
		.style("pointer-events", 'none')
		.on("mouseover", function(d) {
				var node = tooltip.node();
				tooltip.style("display", "block")
					.style("left", Math.max(parseFloat(d3.select(this).attr("cx")) - node.getBoundingClientRect().width, 0) + "px")
					.style("top", Math.max(parseFloat(d3.select(this).attr("cy")) - node.getBoundingClientRect().height, 0) + "px");
			})
			.on("mouseout", function(d) {
				tooltip.style("display", "none");
			});
		
	tooltip = d3.select("#tooltip");
	
	var svg = d3.select("body")
		.append("div")
		.attr("id", "svgcontainer")
		.style("display", "inline-block")
		.append("svg")
		.attr("width", width)
		.attr("height", height);
		
	d3.csv("SkipAverage.csv", function(data) {
		data.AverageSkipPercent = +data["AverageSkipPercent"];
		data.SongName = data["SongName"];
		data.TotalSkips = +data["TotalSkips"];
		data.Artist = data["Artist"];
		data.Minutes = data["Minutes"];
		tempSeconds = +data["Seconds"];
		if (tempSeconds > 9) {
			data.Seconds = data["Seconds"];
		} else {
			data.Seconds = "0" + tempSeconds;
		}
		data.Length = +data["Length"] / 1000;
		return data;
	}, function(error, classes) {

	
	/*color = d3.scale.linear().domain([1,length])
      .interpolate(d3.interpolateHcl)
      .range([d3.rgb("#6699ff"), d3.rgb('#99ff66')]);*/
		var color = d3.scaleLinear()
			.domain([classes[classes.length - 1].AverageSkipPercent, classes[0].AverageSkipPercent])
			.interpolate(d3.interpolateHclLong)
			.range([d3.rgb("#cc66ff"), d3.rgb('#99ff66')]);
	    var nodes = d3.hierarchy({children: classes})
			.sum(function(d) { return d.AverageSkipPercent });
			
		let maxLength = -1;
		let minLength = 50000000;
		for (i = 0; i < classes.length; i++) {
			maxLength = Math.max(classes[i].Length, maxLength);
			minLength = Math.min(classes[i].Length, minLength);
		}
		maxLength = Math.ceil(maxLength);
		minLength = Math.floor(minLength);
			
		var data = pack(nodes).leaves();
			
		var bubbles = svg.selectAll("circle")
			.data(data, function(d) { return d.data.SongName; })
			.enter();
		
		var text = svg.selectAll("text")
			.data(data, function(d) { return d.data.SongName; })
			.enter();

		bubbles.append("circle")
			.attr("r", function(d){ return d.r; })
			.style("fill", function(d, i) { return color(d.data.AverageSkipPercent)})
			.attr("cx", function(d){ return d.x; })
			.attr("cy", function(d){ return d.y; })
			.on("mouseover", function(d) {
				var node = tooltip.node();
				tooltip.style("display", "block")
					.html(d.data.SongName + "<br/>" + d.data.Artist + "<br/>" + "Average Skip:" + d.data.Minutes + ":" + d.data.Seconds)
					.style("left", Math.max(parseFloat(d3.select(this).attr("cx")) - node.getBoundingClientRect().width, 0) + "px")
					.style("top", Math.max(parseFloat(d3.select(this).attr("cy")) - node.getBoundingClientRect().height, 0) + "px");
				d3.select(this).attr("class", "selected").transition(400).style("fill", "#FDBCB4");
			})
			.on("mouseout", function(d) {
				tooltip.style("display", "none");
				d3.select(this).attr("class", null).transition(400).style("fill", function(d, i) { return color(d.data.AverageSkipPercent)});
			});

		 text.append("text")
			.attr("x", function(d){ return d.x; })
			.attr("y", function(d){ return d.y; })
			.text(function(d){ if (d.data.AverageSkipPercent > .35) {
					return d.data.SongName; }})
			.attr("text-anchor", "middle")
			.style('fill', 'black')
			.style('font-family', 'Helvetica Neue, Helvetica, Arial, san-serif')
			.style('font-size', '12px')
			.style('user-select', 'none')
			.style('pointer-events', 'none')
			
			var slideDiv = d3.select("body")
				.append("div")
				.attr("class", "countDiv")
				.style("display", "inline-block")
				.style("vertical-align", "top");
			
			var countDiv = slideDiv.append("div")
				.attr("class", "countDiv")
				.style("display", "block")
				.style("color", "white");
			var percentDiv = slideDiv.append("div")
				.attr("class", "percentDiv")
				.style("display", "block")
				.style("padding-top", "10px")
				.style("color", "white");
			var lengthDiv = slideDiv.append("div")
				.attr("class", "lengthDiv")
				.style("display", "block")
				.style("padding-top", "10px")
				.style("color", "white");
			
				
			countDiv.append("p")
				.text("Min Skip Count: ")
				.append("span")
				.text("1")
				.attr("class", "countDisplay");
			countDiv.append("span")
				.text("1");
			countDiv.append("input")
				.attr("type", "range")
				.attr("min", 1)
				.attr("max", 3)
				.attr("value", 1)
				.attr("class", "countSelect");
			countDiv.append("span")
				.text("3");
			
			percentDiv.append("p")
				.text("Filter by min % Skip: ")
				.append("span")
				.text("0")
				.attr("class", "percentDisplay");
			percentDiv.append("span")
				.text("0");
			percentDiv.append("input")
				.attr("type", "range")
				.attr("min", 0)
				.attr("max", 1)
				.attr("value", 0)
				.attr("step", .01)
				.attr("class", "percentSelect");
			percentDiv.append("span")
				.text("100");
			
			lengthDiv.append("p")
				.text("Filter by min Song Length: ")
				.append("span")
				.text(minLength)
				.attr("class", "lengthDisplay");
			lengthDiv.append("span")
				.text(minLength);
			lengthDiv.append("input")
				.attr("type", "range")
				.attr("min", minLength)
				.attr("max", maxLength)
				.attr("value", minLength)
				.attr("step", 1)
				.attr("class", "lengthSelect");
			lengthDiv.append("span")
				.text(maxLength);
				
			var selected = d3.select(".countSelect");
			var percented = d3.select(".percentSelect");
			var lengthed = d3.select(".lengthSelect");
			
			selected.on("input", function(d) { d3.select(".countDisplay").text(selected.property("value")); })
				    .on("change", function(d) {	updateData(selected.property("value"), percented.property("value"), lengthed.property("value")); });
			percented.on("input", function(d) { d3.select(".percentDisplay").text(Math.round(percented.property("value") * 100)); })
					.on("change", function(d) { updateData(selected.property("value"), percented.property("value"), lengthed.property("value")); });
			lengthed.on("input", function(d) { d3.select(".lengthDisplay").text(lengthed.property("value")); })
					.on("change", function(d) {	updateData(selected.property("value"), percented.property("value"), lengthed.property("value")); });
				
			function updateData(num, skipP, minLength) {
				var s = d3.transition().duration(400);
				var t = d3.transition().duration(750);
				var l = d3.transition().duration(1200);
				var newclasses = classes.filter(function(d) { return (d.TotalSkips > num - 1 && d.AverageSkipPercent > skipP && d.Length >= minLength) });
				if (newclasses.length > 0) {
					color.domain([newclasses[newclasses.length - 1].AverageSkipPercent -.000001, newclasses[0].AverageSkipPercent]);
				}
				var newnodes = d3.hierarchy({children: newclasses})
					.sum(function(d) { return d.AverageSkipPercent });
			
				var newdata = pack(newnodes).leaves();
				
				bubbles = svg.selectAll("circle")
					.data(newdata, function(d) { return d.data.SongName; });
				
				text = svg.selectAll("text")
					.data(newdata, function(d) { return d.data.SongName; });
				
				text.exit().transition(s).attr("opacity", 1e-6).remove();
				bubbles.exit().transition(t).attr("r", 1e-6).remove();
				
				bubbles.transition(t)
					.attr("r", function(d){ return d.r; })
					.attr("cx", function(d){ return d.x; })
					.attr("cy", function(d){ return d.y; })
					.style("fill", function(d, i) { return color(d.data.AverageSkipPercent); });
					
				text.transition(t)
					.attr("x", function(d){ return d.x; })
					.attr("y", function(d){ return d.y; })
					.text(function(d){ if (d.data.AverageSkipPercent > newclasses[0].AverageSkipPercent * .35) {
							return d.data.SongName; }});
					
				bubbles.enter()
					.append("circle")
					.attr("r", function(d){ return 1e-6; })
					.attr("cx", function(d){ return d.x; })
					.attr("cy", function(d){ return d.y; })
					.style("fill", function(d, i) { return color(d.data.AverageSkipPercent); })
					.on("mouseover", function(d) {
						var node = tooltip.node();
						tooltip.style("display", "block")
							.html(d.data.SongName + "<br/>" + d.data.Artist + "<br/>" + "Average Skip:" + d.data.Minutes + ":" + d.data.Seconds)
							.style("left", Math.max(parseFloat(d3.select(this).attr("cx")) - node.getBoundingClientRect().width, 0) + "px")
							.style("top", Math.max(parseFloat(d3.select(this).attr("cy")) - node.getBoundingClientRect().height, 0) + "px");
						d3.select(this).attr("class", "selected").transition(400).style("fill", "#FDBCB4");
					})
					.on("mouseout", function(d) {
						tooltip.style("display", "none");
						d3.select(this).attr("class", null).transition(400).style("fill", function(d, i) { return color(d.data.AverageSkipPercent)});
					})
					.transition(t)
					.attr("r", function(d) { return d.r });
					
				text.enter().append("text")
					.attr("opacity", 1e-6)
					.attr("x", function(d){ return d.x; })
					.attr("y", function(d){ return d.y; })
					.text(function(d){ if (d.data.AverageSkipPercent > newclasses[0].AverageSkipPercent * .35) {
							return d.data.SongName; }})
					.attr("text-anchor", "middle")
					.style('fill', 'black')
					.style('font-family', 'Helvetica Neue, Helvetica, Arial, san-serif')
					.style('font-size', '12px')
					.style('user-select', 'none')
					.style('pointer-events', 'none')
					.on("mouseover", function(d) {
						var node = tooltip.node();
						tooltip.style("display", "block")
							.html(d.data.SongName + "<br/>" + d.data.Artist + "<br/>" + "Average Skip:" + d.data.Minutes + ":" + d.data.Seconds)
							.style("left", Math.max(parseFloat(d3.select(this).attr("cx")) - node.getBoundingClientRect().width, 0) + "px")
							.style("top", Math.max(parseFloat(d3.select(this).attr("cy")) - node.getBoundingClientRect().height, 0) + "px");
					})
					.on("mouseout", function(d) {
						tooltip.style("display", "none");
					})
					.transition(l)
					.attr("opacity", 1);
	}});
</script>
</body